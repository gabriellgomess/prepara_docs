<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Junção de Documentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen">
    <!-- Título da Página -->
     <div class="bg-white border-b border-neutral-200 shadow-sm">
    <div class="container mx-auto px-4 py-6">
      <h1 class="text-3xl font-bold bg-gradient-to-r from-red-800 to-neutral-600 bg-clip-text text-transparent text-center">
        Junção de Documentos
      </h1>
    </div>
  </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Instruções -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-8 rounded-r-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-400 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-medium text-blue-800">Como usar:</h3>
                    <div class="mt-2 text-sm text-blue-700">
                        <ol class="list-decimal list-inside space-y-1">
                            <li>Primeiro, execute as extrações de recibos e contracheques nas outras páginas</li>
                            <li>Faça o upload dos arquivos ZIP gerados pelas extrações</li>
                            <li>O sistema fará o match automático dos nomes (mesmo com nomes incompletos)</li>
                            <li>Baixe os PDFs combinados de cada funcionário</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload de Arquivos -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <!-- Upload Recibos -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-receipt text-blue-500 mr-3"></i>
                    Arquivos de Recibos
                </h3>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
                    <input type="file" id="recibos-input" accept=".zip" class="hidden" onchange="handleRecibosUpload(event)">
                    <label for="recibos-input" class="cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4 block"></i>
                        <p class="text-gray-600">Clique para selecionar o arquivo ZIP dos recibos</p>
                        <p class="text-sm text-gray-500 mt-2">Arquivo gerado pela extração de recibos</p>
                    </label>
                </div>
                <div id="recibos-status" class="mt-4 hidden">
                    <div class="flex items-center text-green-600">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span id="recibos-filename"></span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        <span id="recibos-count"></span> arquivos encontrados
                    </div>
                </div>
            </div>

            <!-- Upload Contracheques -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-file-invoice-dollar text-green-500 mr-3"></i>
                    Arquivos de Contracheques
                </h3>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-400 transition-colors">
                    <input type="file" id="contracheques-input" accept=".zip" class="hidden" onchange="handleContrachequesUpload(event)">
                    <label for="contracheques-input" class="cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4 block"></i>
                        <p class="text-gray-600">Clique para selecionar o arquivo ZIP dos contracheques</p>
                        <p class="text-sm text-gray-500 mt-2">Arquivo gerado pela extração de contracheques</p>
                    </label>
                </div>
                <div id="contracheques-status" class="mt-4 hidden">
                    <div class="flex items-center text-green-600">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span id="contracheques-filename"></span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        <span id="contracheques-count"></span> arquivos encontrados
                    </div>
                </div>
            </div>
        </div>

        <!-- Botão de Processamento -->
        <div class="text-center mb-8">
            <button id="process-btn" onclick="processDocuments()" disabled 
                    class="bg-purple-600 text-white px-8 py-3 rounded-lg font-semibold text-lg disabled:bg-gray-400 disabled:cursor-not-allowed hover:bg-purple-700 transition-colors">
                <i class="fas fa-magic mr-2"></i>
                Processar e Combinar Documentos
            </button>
        </div>

        <!-- Área de Resultados -->
        <div id="results-area" class="hidden">
            <!-- Loading -->
            <div id="loading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                <p class="mt-4 text-gray-600">Processando documentos...</p>
            </div>

            <!-- Matches Encontrados -->
            <div id="matches-section" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Documentos Combinados</h3>
                    <button id="download-all-btn" onclick="downloadAllCombined()" 
                            class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center gap-2">
                        <i class="fas fa-download mr-2"></i>
                        Baixar Todos (ZIP)
                    </button>
                </div>
                <div id="matches-list" class="space-y-4"></div>
            </div>

            <!-- Documentos Não Combinados -->
            <div id="unmatched-section" class="hidden mt-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Documentos Não Combinados</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-medium text-gray-600 mb-2">Recibos sem match:</h4>
                        <div id="unmatched-recibos" class="space-y-2"></div>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-600 mb-2">Contracheques sem match:</h4>
                        <div id="unmatched-contracheques" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let recibosFiles = {};
        let contrachequesFiles = {};

        async function handleRecibosUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const zip = new JSZip();
                const zipContent = await zip.loadAsync(file);
                recibosFiles = {};

                for (const [filename, fileData] of Object.entries(zipContent.files)) {
                    if (filename.endsWith('.pdf') && !fileData.dir) {
                        const arrayBuffer = await fileData.async('arraybuffer');
                        const name = extractNameFromFilename(filename);
                        recibosFiles[name] = {
                            filename: filename,
                            data: arrayBuffer,
                            originalName: name
                        };
                    }
                }

                document.getElementById('recibos-status').classList.remove('hidden');
                document.getElementById('recibos-filename').textContent = file.name;
                document.getElementById('recibos-count').textContent = Object.keys(recibosFiles).length;
                
                checkProcessButton();
            } catch (error) {
                alert('Erro ao processar arquivo de recibos: ' + error.message);
            }
        }

        async function handleContrachequesUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const zip = new JSZip();
                const zipContent = await zip.loadAsync(file);
                contrachequesFiles = {};

                for (const [filename, fileData] of Object.entries(zipContent.files)) {
                    if (filename.endsWith('.pdf') && !fileData.dir) {
                        const arrayBuffer = await fileData.async('arraybuffer');
                        const name = extractNameFromFilename(filename);
                        contrachequesFiles[name] = {
                            filename: filename,
                            data: arrayBuffer,
                            originalName: name
                        };
                    }
                }

                document.getElementById('contracheques-status').classList.remove('hidden');
                document.getElementById('contracheques-filename').textContent = file.name;
                document.getElementById('contracheques-count').textContent = Object.keys(contrachequesFiles).length;
                
                checkProcessButton();
            } catch (error) {
                alert('Erro ao processar arquivo de contracheques: ' + error.message);
            }
        }

        function extractNameFromFilename(filename) {
            // Remove extensão e limpa o nome
            let name = filename.replace('.pdf', '').replace(/^\d+_/, '');
            // Remove caracteres especiais e normaliza
            name = name.replace(/[_-]/g, ' ').trim().toUpperCase();
            return name;
        }

        function checkProcessButton() {
            const hasRecibos = Object.keys(recibosFiles).length > 0;
            const hasContracheques = Object.keys(contrachequesFiles).length > 0;
            document.getElementById('process-btn').disabled = !(hasRecibos && hasContracheques);
        }

        function findBestMatch(name, targetList) {
            let bestMatch = null;
            let bestScore = 0;

            for (const targetName of Object.keys(targetList)) {
                const score = calculateSimilarity(name, targetName);
                if (score > bestScore && score >= 0.7) { // 70% de similaridade mínima
                    bestScore = score;
                    bestMatch = targetName;
                }
            }

            return bestMatch;
        }

        function calculateSimilarity(str1, str2) {
            // Algoritmo de similaridade baseado em substring comum
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            // Verifica se o nome menor está contido no maior
            if (longer.includes(shorter)) {
                return shorter.length / longer.length;
            }
            
            // Calcula distância de Levenshtein normalizada
            const distance = levenshteinDistance(str1, str2);
            return (longer.length - distance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        }

        async function processDocuments() {
            document.getElementById('results-area').classList.remove('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('matches-section').classList.add('hidden');
            document.getElementById('unmatched-section').classList.add('hidden');

            try {
                const matches = [];
                const unmatchedRecibos = { ...recibosFiles };
                const unmatchedContracheques = { ...contrachequesFiles };

                // Encontrar matches
                for (const reciboName of Object.keys(recibosFiles)) {
                    const matchName = findBestMatch(reciboName, contrachequesFiles);
                    if (matchName) {
                        matches.push({
                            name: reciboName,
                            recibo: recibosFiles[reciboName],
                            contracheque: contrachequesFiles[matchName],
                            matchedName: matchName
                        });
                        delete unmatchedRecibos[reciboName];
                        delete unmatchedContracheques[matchName];
                    }
                }

                // Mostrar resultados
                await displayResults(matches, unmatchedRecibos, unmatchedContracheques);

            } catch (error) {
                alert('Erro ao processar documentos: ' + error.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        async function displayResults(matches, unmatchedRecibos, unmatchedContracheques) {
            const matchesList = document.getElementById('matches-list');
            matchesList.innerHTML = '';

            for (const match of matches) {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500';
                
                matchDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-800">${match.name}</h4>
                            <div class="mt-2 space-y-1 text-sm text-gray-600">
                                <div><i class="fas fa-receipt text-blue-500 mr-2"></i>Recibo: ${match.recibo.filename}</div>
                                <div><i class="fas fa-file-invoice-dollar text-green-500 mr-2"></i>Contracheque: ${match.contracheque.filename}</div>
                                ${match.name !== match.matchedName ? `<div class="text-orange-600"><i class="fas fa-link mr-2"></i>Combinado com: ${match.matchedName}</div>` : ''}
                            </div>
                        </div>
                        <button onclick="downloadCombinedPDF('${match.name}', '${matches.indexOf(match)}')" 
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>Baixar PDF
                        </button>
                    </div>
                `;
                
                matchesList.appendChild(matchDiv);
            }

            // Armazenar matches globalmente para download
            window.currentMatches = matches;

            document.getElementById('matches-section').classList.remove('hidden');

            // Mostrar documentos não combinados se houver
            if (Object.keys(unmatchedRecibos).length > 0 || Object.keys(unmatchedContracheques).length > 0) {
                displayUnmatched(unmatchedRecibos, unmatchedContracheques);
            }
        }

        function displayUnmatched(unmatchedRecibos, unmatchedContracheques) {
            const unmatchedRecibosDiv = document.getElementById('unmatched-recibos');
            const unmatchedContrachequesDiv = document.getElementById('unmatched-contracheques');
            
            unmatchedRecibosDiv.innerHTML = '';
            unmatchedContrachequesDiv.innerHTML = '';

            for (const name of Object.keys(unmatchedRecibos)) {
                const div = document.createElement('div');
                div.className = 'bg-orange-50 border border-orange-200 rounded p-3 text-sm';
                div.innerHTML = `<i class="fas fa-receipt text-orange-500 mr-2"></i>${name}`;
                unmatchedRecibosDiv.appendChild(div);
            }

            for (const name of Object.keys(unmatchedContracheques)) {
                const div = document.createElement('div');
                div.className = 'bg-orange-50 border border-orange-200 rounded p-3 text-sm';
                div.innerHTML = `<i class="fas fa-file-invoice-dollar text-orange-500 mr-2"></i>${name}`;
                unmatchedContrachequesDiv.appendChild(div);
            }

            document.getElementById('unmatched-section').classList.remove('hidden');
        }

        function extractFirstAndLastName(fullName) {
            // Remove caracteres especiais e normaliza
            const cleanName = fullName.replace(/[^a-zA-ZÀ-ÿ\s]/g, '').trim();
            const nameParts = cleanName.split(/\s+/).filter(part => part.length > 0);
            
            if (nameParts.length === 0) return 'NOME_DESCONHECIDO';
            if (nameParts.length === 1) return nameParts[0];
            
            // Primeiro nome + último nome
            const firstName = nameParts[0];
            const lastName = nameParts[nameParts.length - 1];
            
            return `${firstName} ${lastName}`;
        }

        function generateFileName(fullName) {
            // Data no formato YYYYMMDD
            const today = new Date();
            const dateStr = today.getFullYear().toString() + 
                           (today.getMonth() + 1).toString().padStart(2, '0') + 
                           today.getDate().toString().padStart(2, '0');
            
            // Extrair primeiro e último nome
            const shortName = extractFirstAndLastName(fullName);
            
            // Formato: YYYYMMDD - PRIMEIRO ULTIMO - CMDCA.pdf
            return `${dateStr} - ${shortName} - CMDCA.pdf`;
        }

        async function downloadCombinedPDF(name, index) {
            try {
                const match = window.currentMatches[index];
                const pdfDoc = await PDFLib.PDFDocument.create();

                // Adicionar recibo
                const reciboPdf = await PDFLib.PDFDocument.load(match.recibo.data);
                const reciboPages = await pdfDoc.copyPages(reciboPdf, reciboPdf.getPageIndices());
                reciboPages.forEach((page) => pdfDoc.addPage(page));

                // Adicionar contracheque
                const contrachequePdf = await PDFLib.PDFDocument.load(match.contracheque.data);
                const contrachequePages = await pdfDoc.copyPages(contrachequePdf, contrachequePdf.getPageIndices());
                contrachequePages.forEach((page) => pdfDoc.addPage(page));

                // Gerar PDF final
                const pdfBytes = await pdfDoc.save();
                
                // Download com nova nomenclatura
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = generateFileName(name);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                alert('Erro ao gerar PDF: ' + error.message);
            }
        }

        async function downloadAllCombined() {
            if (!window.currentMatches || window.currentMatches.length === 0) {
                alert('Nenhum documento combinado disponível para download.');
                return;
            }

            try {
                // Mostrar loading no botão
                const btn = document.getElementById('download-all-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando ZIP...';
                btn.disabled = true;

                const zip = new JSZip();
                const folder = zip.folder("documentos_combinados");

                // Gerar PDFs combinados para cada match
                for (let i = 0; i < window.currentMatches.length; i++) {
                    const match = window.currentMatches[i];
                    
                    // Criar PDF combinado
                    const pdfDoc = await PDFLib.PDFDocument.create();

                    // Adicionar recibo
                    const reciboPdf = await PDFLib.PDFDocument.load(match.recibo.data);
                    const reciboPages = await pdfDoc.copyPages(reciboPdf, reciboPdf.getPageIndices());
                    reciboPages.forEach((page) => pdfDoc.addPage(page));

                    // Adicionar contracheque
                    const contrachequePdf = await PDFLib.PDFDocument.load(match.contracheque.data);
                    const contrachequePages = await pdfDoc.copyPages(contrachequePdf, contrachequePdf.getPageIndices());
                    contrachequePages.forEach((page) => pdfDoc.addPage(page));

                    // Gerar PDF final
                    const pdfBytes = await pdfDoc.save();
                    
                    // Adicionar ao ZIP com nova nomenclatura
                    const fileName = generateFileName(match.name);
                    folder.file(fileName, pdfBytes);
                }

                // Gerar e baixar ZIP
                const zipBlob = await zip.generateAsync({type: "blob"});
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `documentos_combinados_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Restaurar botão
                btn.innerHTML = originalText;
                btn.disabled = false;

            } catch (error) {
                alert('Erro ao gerar ZIP: ' + error.message);
                
                // Restaurar botão em caso de erro
                const btn = document.getElementById('download-all-btn');
                btn.innerHTML = '<i class="fas fa-download mr-2"></i>Baixar Todos (ZIP)';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>